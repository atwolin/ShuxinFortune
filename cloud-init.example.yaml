#cloud-config

# This cloud-init configuration sets up a Container-Optimized OS VM
# to run Docker Compose using a pure cloud-init approach (no deprecated container startup agent).
# Docker Compose is installed and run via systemd service.

write_files:
  # Docker Compose configuration file
  - path: /home/compose/docker-compose.yaml
    permissions: 0644
    owner: root
    content: |
      version: '3.8'
      services:
        backend:
          build:
            context: https://github.com/atwolin/ShuxinFortune.git#main:backend
            dockerfile: Dockerfile.prod
          env_file:
            - .env
          volumes:
            - backend_data:/app/data
            - backend_static:/app/staticfiles
          ports:
            - "8000:8000"
          networks:
            - fortune
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/admin/login/"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

        frontend:
          build:
            context: https://github.com/atwolin/ShuxinFortune.git#main:frontend
            dockerfile: Dockerfile
          volumes:
            - letsencrypt:/etc/letsencrypt
            - certbot_www:/var/www/certbot
          ports:
            - "80:80"
            - "443:443"
          networks:
            - fortune
          depends_on:
            - backend
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:80/"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s

      networks:
        fortune:
          driver: bridge

      volumes:
        backend_data:
        backend_static:
        letsencrypt:
        certbot_www:

  # Environment variables file
  - path: /home/compose/.env
    permissions: 0600
    owner: root
    content: |
      # ======================
      # Django Backend Settings
      # ======================

      # SECURITY WARNING: Replace with your actual secret key
      # Generate: python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'
      DJANGO_SECRET_KEY=REPLACE_WITH_YOUR_SECRET_KEY

      DJANGO_DEBUG=False
      DJANGO_ALLOWED_HOSTS=shuxin-fortune.ddns.net,34.132.123.85,localhost,127.0.0.1

      # ======================
      # CORS Settings
      # ======================

      # For production: https://your-domain.com,https://shuxin-fortune.ddns.net
      DJANGO_CORS_ALLOWED_ORIGINS=YOUR_ALLOWED_ORIGINS
      DJANGO_CORS_ALLOW_CREDENTIALS=True

      # ======================
      # CSRF Settings
      # ======================

      # For production: https://your-domain.com,https://shuxin-fortune.ddns.net
      DJANGO_CSRF_TRUSTED_ORIGINS=YOUR_TRUSTED_ORIGINS

      # ======================
      # Database Settings
      # ======================

      DJANGO_DATABASE_URL=sqlite:///data/db.sqlite3

      # ======================
      # Security Settings (Production)
      # ======================

      # DJANGO_SECURE_SSL_REDIRECT=True
      # DJANGO_SESSION_COOKIE_SECURE=True
      # DJANGO_CSRF_COOKIE_SECURE=True
      # DJANGO_SECURE_HSTS_SECONDS=2592000
      # DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS=True
      # DJANGO_SECURE_HSTS_PRELOAD=True

      # ======================
      # Security Settings (Development)
      # ======================

      DJANGO_SECURE_SSL_REDIRECT=False
      DJANGO_SESSION_COOKIE_SECURE=False
      DJANGO_CSRF_COOKIE_SECURE=False
      DJANGO_SECURE_HSTS_SECONDS=0
      DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS=False
      DJANGO_SECURE_HSTS_PRELOAD=False

  # Systemd service for docker-compose
  - path: /etc/systemd/system/docker-compose-app.service
    permissions: 0644
    owner: root
    content: |
      [Unit]
      Description=Docker Compose Application Service
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/home/compose
      ExecStart=/usr/bin/docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v /home/compose:/workdir \
        -w /workdir \
        docker/compose:latest \
        up -d --build --remove-orphans
      ExecStop=/usr/bin/docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v /home/compose:/workdir \
        -w /workdir \
        docker/compose:latest \
        down

      [Install]
      WantedBy=multi-user.target

runcmd:
  # Ensure /home/compose directory has proper permissions
  - chmod 755 /home/compose
  - chmod 644 /home/compose/docker-compose.yaml
  - chmod 600 /home/compose/.env

  # Pull docker-compose image to speed up first start
  - docker pull docker/compose:latest

  # Enable and start the docker-compose service
  - systemctl daemon-reload
  - systemctl enable docker-compose-app.service
  - systemctl start docker-compose-app.service
